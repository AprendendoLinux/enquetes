{% extends "base.html" %}

{% block title %}Nova Senha{% endblock %}

{% block extra_css %}
<style>
    /* Wrapper para centralizar verticalmente */
    .reset-wrapper {
        min-height: calc(100vh - 200px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding-bottom: 2rem;
    }

    .card-split { 
        border: none; 
        border-radius: 24px; 
        box-shadow: 0 20px 60px rgba(0,0,0,0.1); 
        overflow: hidden; 
        max-width: 900px; 
        width: 100%; 
        margin: auto; 
        background: #fff;
    }

    .brand-panel { 
        background: linear-gradient(135deg, #212529 0%, #343a40 100%); 
        color: white; 
        padding: 3rem; 
        display: flex; 
        flex-direction: column; 
        justify-content: center; 
        align-items: center; 
        text-align: center; 
        min-height: 100%;
    }

    .form-panel { 
        padding: 3rem; 
        background: white; 
        display: flex; 
        flex-direction: column; 
        justify-content: center; 
    }

    /* Estilização dos Inputs e do Grupo */
    .form-control-lg { 
        border-radius: 10px; 
        font-size: 0.95rem; 
        background-color: #f8f9fa; 
        border: 1px solid #e0e0e0; 
        padding-right: 45px; /* Espaço para o ícone não ficar em cima do texto */
    }
    
    .form-control-lg:focus {
        background-color: #fff;
        box-shadow: 0 0 0 3px rgba(33, 37, 41, 0.1);
        border-color: #212529;
        z-index: 1; /* Garante que a borda fique sobre o botão se necessário */
    }

    /* CSS específico para o botão do olho ficar "dentro" do input */
    .input-group {
        position: relative;
    }
    
    .btn-toggle-password {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background: transparent;
        color: #6c757d;
        z-index: 5;
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
    }
    
    .btn-toggle-password:hover {
        color: #212529;
    }

    .btn-dark-lg { 
        padding: 0.9rem; 
        border-radius: 12px; 
        font-weight: 700; 
    }

    /* Ajuste Responsivo */
    @media (max-width: 767.98px) {
        .brand-panel { padding: 2rem 1rem; }
        .form-panel { padding: 2rem 1.5rem; }
        
        .reset-wrapper { 
            min-height: auto; 
            display: block;
            margin-top: -20px; 
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="reset-wrapper">
  <div class="card card-split">
    <div class="row g-0 h-100">
      
      <div class="col-md-5 brand-panel">
        <i class="bi bi-shield-lock-fill display-1 mb-3 text-white-50"></i>
        <h3 class="fw-bold mb-2">Segurança</h3>
        <p class="text-white-50 small mb-0">Crie uma senha forte para proteger sua conta.</p>
      </div>

      <div class="col-md-7 form-panel">
        <h4 class="fw-bold text-dark mb-2">Definir Nova Senha</h4>
        <p class="text-muted small mb-4">Digite sua nova senha abaixo.</p>
        
        <form action="/auth/reset-password" method="post" id="resetForm">
          <input type="hidden" name="token" value="{{ token }}">
          
          <div class="mb-3">
            <label class="form-label small fw-bold text-muted">Nova Senha</label>
            <div class="input-group">
                <input type="password" id="new_password" name="new_password" class="form-control form-control-lg" required minlength="4">
                <button type="button" class="btn-toggle-password" onclick="togglePassword('new_password', 'icon-new')">
                    <i class="bi bi-eye" id="icon-new"></i>
                </button>
            </div>
          </div>

          <div class="mb-4">
            <label class="form-label small fw-bold text-muted">Confirme a Senha</label>
            <div class="input-group">
                <input type="password" id="confirm_password" name="confirm_password" class="form-control form-control-lg" required>
                <button type="button" class="btn-toggle-password" onclick="togglePassword('confirm_password', 'icon-confirm')">
                    <i class="bi bi-eye" id="icon-confirm"></i>
                </button>
            </div>
            <div id="passwordMismatch" class="invalid-feedback fw-bold mt-2" style="display: none;">
                As senhas não coincidem.
            </div>
          </div>

          <div class="d-grid">
            <button type="submit" class="btn btn-dark btn-dark-lg shadow-sm">Salvar Senha</button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Função para alternar visibilidade da senha
    function togglePassword(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);
        
        if (input.type === "password") {
            input.type = "text";
            icon.classList.remove("bi-eye");
            icon.classList.add("bi-eye-slash");
        } else {
            input.type = "password";
            icon.classList.remove("bi-eye-slash");
            icon.classList.add("bi-eye");
        }
    }

    // Validação do formulário
    document.getElementById('resetForm').addEventListener('submit', function(event) {
      const password = document.getElementById('new_password');
      const confirmPassword = document.getElementById('confirm_password');
      const mismatchMsg = document.getElementById('passwordMismatch');
      let isValid = true;

      // Validação de igualdade
      if (password.value !== confirmPassword.value) {
        confirmPassword.classList.add('is-invalid');
        mismatchMsg.style.display = 'block';
        isValid = false;
      } else {
        confirmPassword.classList.remove('is-invalid');
        mismatchMsg.style.display = 'none';
      }

      // Validação nativa
      if (!this.checkValidity()) {
        isValid = false;
        this.classList.add('was-validated');
      }

      if (!isValid) {
        event.preventDefault();
        event.stopPropagation();
      }
    });

    // Limpa erro ao digitar
    document.getElementById('confirm_password').addEventListener('input', function() {
      this.classList.remove('is-invalid');
      document.getElementById('passwordMismatch').style.display = 'none';
    });
</script>
{% endblock %}